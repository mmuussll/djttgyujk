<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة السدادات - نظام إدارة الديون</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>

    <header>
        <h1>نظام إدارة الديون</h1>
        <nav>
            <ul>
                <li><a href="dashboard.html">لوحة التحكم</a></li>
                <li><a href="customers.html">الزبائن</a></li>
                <li><a href="debts.html">الديون</a></li>
                <li><a href="payments.html">السدادات</a></li>
                <li><a href="reports.html">التقارير</a></li>
                <li><a href="#" id="login-logout-link">تسجيل الخروج</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="payments-content">
            <h2>إدارة السدادات</h2>
            
            <div id="add-payment-form" class="form-section">
                <h3>إضافة سداد جديد</h3>
                <form id="payment-form">
                    <div class="form-group">
                        <label for="payment-debt">الدين:</label>
                        <select id="payment-debt" name="payment-debt" required>
                            <option value="">اختر ديناً</option>
                            <!-- سيتم ملء الديون هنا -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="payment-amount">المبلغ:</label>
                        <input type="number" id="payment-amount" name="payment-amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="payment-date">التاريخ:</label>
                        <input type="date" id="payment-date" name="payment-date" required>
                    </div>
                    <button type="submit" class="btn">إضافة السداد</button>
                </form>
            </div>
            
            <div id="payments-list" class="list-section">
                <h3>قائمة السدادات</h3>
                <table id="payments-table">
                    <thead>
                        <tr>
                            <th>الدين</th>
                            <th>الزبون</th>
                            <th>المبلغ</th>
                            <th>التاريخ</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="payments-tbody">
                        <!-- سيتم ملء البيانات هنا -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2024 جميع الحقوق محفوظة.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // التحقق من حالة تسجيل الدخول
            const { data: { session } } = await window.supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            // تحديث رابط تسجيل الخروج
            const loginLogoutLink = document.getElementById('login-logout-link');
            loginLogoutLink.textContent = 'تسجيل الخروج';
            loginLogoutLink.href = '#';
            loginLogoutLink.addEventListener('click', async (e) => {
                e.preventDefault();
                await window.supabase.auth.signOut();
                window.location.href = 'index.html';
            });

            // تحميل قائمة الديون لقائمة التحديد
            loadDebtsForSelect();
            
            // تحميل قائمة السدادات
            loadPayments();

            // إضافة مستمع لنموذج إضافة السداد
            document.getElementById('payment-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const debtId = document.getElementById('payment-debt').value;
                const amount = parseFloat(document.getElementById('payment-amount').value);
                const date = document.getElementById('payment-date').value;
                
                try {
                    await addPayment(debtId, amount, date);
                    // مسح الحقول
                    document.getElementById('payment-form').reset();
                    // إعادة تحميل قائمة السدادات
                    loadPayments();
                } catch (error) {
                    console.error('Error adding payment:', error);
                    alert('حدث خطأ أثناء إضافة السداد');
                }
            });
        });

        async function loadDebtsForSelect() {
            try {
                const { data: debts, error } = await window.supabase
                    .from('debts')
                    .select(`
                        id,
                        amount,
                        description,
                        customers(name)
                    `);
                
                if (error) throw error;
                
                const select = document.getElementById('payment-debt');
                select.innerHTML = '<option value="">اختر ديناً</option>';
                
                debts.forEach(debt => {
                    const option = document.createElement('option');
                    option.value = debt.id;
                    option.textContent = `${debt.customers?.name || 'غير معروف'} - ${parseFloat(debt.amount).toFixed(2)} - ${debt.description || ''}`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading debts for select:', error);
            }
        }

        async function loadPayments() {
            try {
                const { data: payments, error } = await window.supabase
                    .from('payments')
                    .select(`
                        id,
                        amount,
                        date,
                        debts(id, amount, customers(name))
                    `);
                
                if (error) throw error;
                
                const tbody = document.getElementById('payments-tbody');
                tbody.innerHTML = '';
                
                payments.forEach(payment => {
                    const row = tbody.insertRow();
                    // عرض وصف الدين
                    row.insertCell(0).textContent = `دين ${payment.debts?.id || ''}`;
                    row.insertCell(1).textContent = payment.debts?.customers?.name || 'غير معروف';
                    row.insertCell(2).textContent = parseFloat(payment.amount).toFixed(2);
                    row.insertCell(3).textContent = payment.date;
                    
                    const actionsCell = row.insertCell(4);
                    
                    // زر الحذف
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'حذف';
                    deleteBtn.className = 'btn btn-danger';
                    deleteBtn.onclick = () => deletePayment(payment.id);
                    actionsCell.appendChild(deleteBtn);
                });
            } catch (error) {
                console.error('Error loading payments:', error);
                alert('حدث خطأ أثناء تحميل قائمة السدادات');
            }
        }

        async function deletePayment(paymentId) {
            if (!confirm('هل أنت متأكد من حذف هذا السداد؟')) return;
            
            try {
                await window.supabase
                    .from('payments')
                    .delete()
                    .eq('id', paymentId);
                
                loadPayments(); // إعادة تحميل القائمة
            } catch (error) {
                console.error('Error deleting payment:', error);
                alert('حدث خطأ أثناء حذف السداد');
            }
        }
    </script>
    
    <style>
        .form-section {
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .list-section {
            background: #fff;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 10px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f2f2f2;
        }
        
        .btn-danger {
            background-color: #dc3545;
            margin-right: 5px;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
    </style>
</body>
</html>